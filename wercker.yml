box: maven:latest
build:
  steps:
    - xenoterracide/maven:
        goals: package spring-boot:repackage
    - script:
        name: copy package to output
        code: |
          cp ./target/*.jar $WERCKER_OUTPUT_DIR/cloud-ci-vergleich.jar
deploy:
  box:
    id: openjdk
    tag: 8-jre-alpine
    cmd: /bin/sh
  steps:
    - script:
      code: |
        mv $WERCKER_SOURCE_DIR/cloud-ci-vergleich.jar /cloud-ci-vergleich.jar
        touch /cloud-ci-vergleich.jar
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        tag: latest
        repository: $DOCKER_REPOSITORY
        ports: "8080"
        volumes: "/tmp"
        entrypoint: java -Djava.security.egd=file:/dev/./urandom -jar /cloud-ci-vergleich.jar
    - script:
      code: |
        touch  $WERCKER_OUTPUT_DIR/deploy-me
update-deplyoment:
  steps:
    - script:
      name: Update OCCS deployment
      code: |
        export RESET_URL="$(curl -sk -X "PUT" -H "Authorization: Bearer ${OCCS_API_KEY}" "${OCCS_BASE_URL}/api/v2/deployments/${OCCS_DEPLOYMENT_ID}/webhook/restart" -d '{"enabled":true}' | grep full_url_path | cut -d'"' -f4)"
        curl -sk -X "POST" "${OCCS_BASE_URL}${RESET_URL}"
